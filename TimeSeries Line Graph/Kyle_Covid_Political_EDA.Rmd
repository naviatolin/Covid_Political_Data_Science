---
title: "Covid/Political EDA"
output: github_document
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code.

Try executing this chunk by clicking the _Run_ button within the chunk or by placing your cursor inside it and pressing _Ctrl+Shift+Enter_.

```{r}
library(tidyverse)
```

```{r df-pol}
political_filepath <- "./data/US_County_Level_Presidential_Results_08-16.csv"
df_pol<- read_csv(political_filepath)
df_pol_sorted <- df_pol %>%
  mutate(fips_code = paste0(0,fips_code)) %>%
  separate(fips_code, into = c("zeros","fips_code"), sep = -5) %>%
  select(fips_code, total_2016, dem_2016, gop_2016, oth_2016) %>%
  arrange(fips_code)
df_pol_sorted
?separate
```

```{r df-pop}
census_filepath <- "./data/ACSDT5Y2018.B01003_data_with_overlays_2020-10-07T194616.csv"
df_pop <- read_csv(census_filepath)
df_pop_sorted <- df_pop %>%
  separate(col = id, into = c("id_firstpart", "fips"), sep = -5) %>%
  select('fips', 'Geographic Area Name', 'Estimate!!Total') %>%
  rename("population" = "Estimate!!Total")
df_pop_sorted

```

```{r download-data}
# url for county specific covid data
url_covid_counties <- "https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties.csv"

# where to write file to
filename_nyt <- "./data/nyt_counties.csv"

## Download the data locally
curl::curl_download(
        url_counties,
        destfile = filename_nyt
      )

## Loads the downloaded csv
df_covid <- read_csv(filename_nyt)
df_covid
```

```{r join-datasets}
df_joined <- df_covid %>%
  left_join(df_pop_sorted, by = "fips") %>%
  left_join(df_pol_sorted, by = c("fips" = "fips_code")) %>%
  select(date, fips, county, state, population, cases, deaths, total_2016, dem_2016, gop_2016, oth_2016 )
df_joined
?left_join
```

```{r normalize-data}
df_normalized <-
  df_joined %>%
  mutate(
    cases_per100k = cases / population * 100000,
    deaths_per100k = deaths / population * 100000
    ) %>%
  mutate(
    per_dem = dem_2016/total_2016*100,
    per_gop = gop_2016/total_2016*100,
    per_oth = oth_2016/total_2016*100,
    per_vote = total_2016/population*100
    ) %>%
  mutate(county_party = if_else(per_gop >= per_dem, "R", "D")) %>%
  drop_na()
df_normalized
```

```{r adding-state-party}
df_state_party <-
  df_normalized %>%
  group_by(state) %>%
  summarize(state_tot = sum(total_2016), dem_total = sum(dem_2016), gop_total = sum(gop_2016)) %>%
  mutate(state_party = if_else(gop_total >= dem_total, "R","D")) %>%
  select(state, state_party)
df_state_party
```

```{r normalizing-state}
df_norm_state <-
  df_normalized %>%
  left_join(df_state_party, by = "state")
df_norm_state
```

```{r slimming-dataset}
df_normalized_slim <-
  df_norm_state %>%
  select(date, fips, county, state, population, cases_per100k, deaths_per100k, county_party, state_party)
df_normalized_slim
```

```{r filter-one-date}
df_normalized_slim %>%
  filter(date == "2020-10-15") %>%
  arrange(desc(cases_per100k))
```

```{r plot1}
df_norm_state %>%
  #filter(date >= as.Date("2020-04-01")) %>%
  group_by(date, county_party) %>%
  summarize(cases = sum(cases), mean_per100k = mean(cases_per100k)) %>%
  ggplot()+
  geom_line(aes(date, mean_per100k, color = county_party)) #+
  #scale_y_log10()
```

```{r plot2}
df_norm_state %>%
  #filter(date >= as.Date("2020-04-01")) %>%
  group_by(date, county_party) %>%
  summarize(cases = sum(cases), mean_per100k = mean(cases_per100k)) %>%
  ggplot()+
  geom_line(aes(date, cases, color = county_party))# +
  #scale_y_log10()
```

```{r plot3}
df_norm_state %>%
  #filter(date >= as.Date("2020-04-01")) %>%
  group_by(date, state_party) %>%
  summarize(cases = sum(cases), mean_per100k = mean(cases_per100k)) %>%
  ggplot()+
  geom_line(aes(date, mean_per100k, color = state_party)) #+
  #scale_y_log10()
```

```{r plot4}
df_norm_state %>%
  #filter(date >= as.Date("2020-04-01")) %>%
  group_by(date, state_party) %>%
  summarize(cases = sum(cases), mean_per100k = mean(cases_per100k)) %>%
  ggplot()+
  geom_line(aes(date, cases, color = state_party))# +
  #scale_y_log10()
```

```{r plot5}
df_norm_state %>%
  #filter(date >= as.Date("2020-04-01")) %>%
  group_by(date, state_party) %>%
  summarize(deaths = sum(deaths), meandeaths_per100k = mean(deaths_per100k)) %>%
  ggplot()+
  geom_line(aes(date, deaths, color = state_party))# +
  #scale_y_log10()
```

```{r df-new-cases}
df_new_cases <-
  df_norm_state %>%
  group_by(fips) %>%
  mutate(
    new_cases = cases - lag(cases, default = 0),
    new_cases_per100k = new_cases/population*100000,
    new_deaths = deaths - lag(deaths, default = 0),
    new_deaths_per100k = new_deaths/population*100000
    )%>%
  mutate(roll7 = (new_cases +
           lag(new_cases, n = 2L, default = 0)+
           lag(new_cases, n = 3L, default = 0)+
           lag(new_cases, n = 4L, default = 0)+
           lag(new_cases, n = 5L, default = 0)+
           lag(new_cases, n = 6L, default = 0)+
           lag(new_cases, n = 7L, default = 0))/7
         ) %>%
  mutate(roll7_deaths = (new_deaths +
           lag(new_deaths, n = 2L, default = 0)+
           lag(new_deaths, n = 3L, default = 0)+
           lag(new_deaths, n = 4L, default = 0)+
           lag(new_deaths, n = 5L, default = 0)+
           lag(new_deaths, n = 6L, default = 0)+
           lag(new_deaths, n = 7L, default = 0))/7
         ) %>%
  mutate(
    roll7_per100k= roll7/population * 100000,
    roll7_deaths_per100k= roll7_deaths/population * 100000,
  )

df_new_cases
```

**Plotting Polished Graphs**

```{r polish1}
theme_common <- function() {
  theme_minimal() %+replace%
  theme(
    axis.text.x = element_text(size = 10),
    axis.text.y = element_text(size = 10),
    axis.title.x = element_text(margin = margin(4, 4, 4, 4), size = 12),
    axis.title.y = element_text(margin = margin(4, 4, 4, 4), size = 12, angle = 90),

    legend.title = element_text(size = 12),
    legend.text = element_text(size = 10),

    strip.text.x = element_text(size = 12),
    strip.text.y = element_text(size = 12),

    panel.background = element_rect(fill = "grey95", color = "white"),
    panel.grid.major = element_line(color = "grey80"),
    panel.grid.minor = element_line(color = "grey80"),

    aspect.ratio = 4 / 6,

    plot.margin = unit(c(t = +0, b = +0, r = +0, l = +0), "cm"),
    plot.title = element_text(size = 18, vjust = 2),
    #plot.title.position = "plot",
    plot.subtitle = element_text(size = 16),
    plot.caption = element_text(size = 12)
  )
}
```

```{r polish2}
df_new_cases %>%
  filter(date >= as.Date("2020-03-15")) %>%
  group_by(date, state_party) %>%
  summarize(mean_new_cases = mean(new_cases), new_cases = sum(new_cases), new_cases_per100k = sum(new_cases_per100k), roll7 = sum(roll7), roll7_per100k = sum(roll7_per100k)) %>%
  ggplot()+
  geom_line(aes(date, roll7, color = state_party)) +
  scale_color_manual(labels = c("Democratic", "Republican"), values = c('Blue','Red'))+
  labs(
    title = "New Covid Cases over Time by Political Party",
    x = "Date",
    y = "7 Day Average of New Cases",
    color = "State Party"
  ) +
  theme_common()
```

**Observations**

- Initially there were more new cases per day in democratic states
- New cases spiked for both democratic and republican states towards the end of June, however new cases spiked by significantly more in Republican states
- There have been more new cases per day in republican states(when compared to democratic state) since Mid June
- As of right now(mid-october) there are apprx 35k new cases per day in republican states and 22k new cases per day in democratic states, and new cases are spiking in both groups

```{r polish3}
df_new_cases %>%
  filter(date >= as.Date("2020-03-15")) %>%
  group_by(date, state_party) %>%
  summarize(roll7_deaths = sum(roll7_deaths), roll7_deaths_per100k = sum(roll7_deaths_per100k)) %>%
  ggplot()+
  geom_line(aes(date, roll7_deaths, color = state_party)) +
  scale_color_manual(labels = c("Democratic", "Republican"), values = c('Blue','Red'))+
  labs(
    title = "New Covid Deaths over Time by Political Party",
    x = "Date",
    y = "7 Day Average of New Deaths",
    color = "State Party"
  ) +
  theme_common()
```

**Observations**

- Initially there were more new deaths per day in democratic states
- New deaths spiked for republican states towards the beginning of July
- There have been more new deaths per day in republican states(when compared to democratic state) since the start of July

```{r polish4}
df_norm_state %>%
  filter(date >= as.Date("2020-03-15")) %>%
  group_by(date, state_party) %>%
  summarize(cases = sum(cases), mean_per100k = mean(cases_per100k)) %>%
  ggplot()+
  geom_line(aes(date, cases, color = state_party))+
  scale_color_manual(labels = c("Democratic", "Republican"), values = c('Blue','Red'))+
  labs(
    title = "Total Covid Cases over Time by Political Party",
    x = "Date",
    y = "Total Covid Cases",
    color = "State Party"
  ) +
  theme_common()
```

**Observations**

- Initially there were more cases in democratic states
- Covid cases in republican states increased rapidly in late June/early July and surpased the number of cases in democratic states

```{r polish5}
df_norm_state %>%
  filter(date >= as.Date("2020-03-15")) %>%
  group_by(date, state_party) %>%
  summarize(deaths = sum(deaths), meandeaths_per100k = mean(deaths_per100k)) %>%
  ggplot()+
  geom_line(aes(date, deaths, color = state_party)) +
  #scale_y_log10() +
  scale_color_manual(labels = c("Democratic", "Republican"), values = c('Blue','Red'))+
  labs(
    title = "Total Covid Deaths over Time by Political Party",
    x = "Date",
    y = "Total Covid Deaths",
    color = "State Party"
  ) +
  theme_common()
```

**Observations**

- Deaths in Democratic states were initially high
- Total deaths in republican states surpassed total deaths in democratic states in early October
- Even though case count shifted in early July deaths are only catching up now, implications?!?
