---
title: "Project 1: COVID Political Analysis"
output: html_notebook
---
**Our Question:**

In this project, we set out to answer the question: Is there a correlation between political affiliation of a county/state and their COVID case trends? Do predominantly democrat states have lower numbers of COVID cases per capita?

TO DO: ADD some sentences about mask mandates being first in democrat states, and seemingly more closely followed social distancing rules/masks accepted

**Our Additional Dataset:**

The additional dataset that we decided to use comes from townhall.com and includes county-based results of the 2016 election across the US. Townhall is a self described "leading source for conservative news and political commentary." Based on initial investigation, I would classify this source as reputable as a standard news reporting website in 2020. Their data collection procedures are not documented on the website, that we can find. It is possible that they are not the original source for the data, but it is hard to trace back. This data source would probably be considered not reputable for a lot of other analysis and such, because it is inherently biased politically. However, because presidential election data results from 2016 have been readily available for a while now, and the results of it are far from a mystery, we can assume that their election results data is reasonably reputable. That being said, especially in recent events, we have seen some manipulation of accepted true data. For this reason, we want to acknowledge that this data source is inherently biased and there is theoretically a potential/motivation to have manipulated results, but we think it is not likely. In terms of unintentional error, it is possible that some of these counties have been incorrectly reported, or numbers are estimates, especially for smaller, less connected counties. There do not appear to be any missing counties in this dataset. (IS HAWAII ON HERE? ALASKS?)

**Relevant Background:**
TO DO: add background...

**Graphs/Analysis/Conclusions:**

```{r}
library(tidyverse)
```

```{r df-pol}
political_filepath <- "./data/US_County_Level_Presidential_Results_08-16.csv"
df_pol<- read_csv(political_filepath)
df_pol_sorted <- df_pol %>%
  mutate(fips_code = paste0(0,fips_code)) %>%
  separate(fips_code, into = c("zeros","fips_code"), sep = -5) %>%
  select(fips_code, total_2016, dem_2016, gop_2016, oth_2016) %>%
  arrange(fips_code)
df_pol_sorted
?separate
```

```{r df-pop}
census_filepath <- "./data/ACSDT5Y2018.B01003_data_with_overlays_2020-10-07T194616.csv"
df_pop <- read_csv(census_filepath)
df_pop_sorted <- df_pop %>%
  separate(col = id, into = c("id_firstpart", "fips"), sep = -5) %>%
  select('fips', 'Geographic Area Name', 'Estimate!!Total') %>%
  rename("population" = "Estimate!!Total")
df_pop_sorted

```

```{r download-data}
# url for county specific covid data
url_covid_counties <- "https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties.csv"

# where to write file to
filename_nyt <- "./data/nyt_counties.csv"

## Download the data locally
curl::curl_download(
        url_counties,
        destfile = filename_nyt
      )

## Loads the downloaded csv
df_covid <- read_csv(filename_nyt)
df_covid
```

```{r join-datasets}
df_joined <- df_covid %>%
  left_join(df_pop_sorted, by = "fips") %>%
  left_join(df_pol_sorted, by = c("fips" = "fips_code")) %>%
  select(date, fips, county, state, population, cases, deaths, total_2016, dem_2016, gop_2016, oth_2016 )
df_joined
?left_join
```

```{r normalize-data}
df_normalized <-
  df_joined %>%
  mutate(
    cases_per100k = cases / population * 100000,
    deaths_per100k = deaths / population * 100000
    ) %>%
  mutate(
    per_dem = dem_2016/total_2016*100,
    per_gop = gop_2016/total_2016*100,
    per_oth = oth_2016/total_2016*100,
    per_vote = total_2016/population*100
    ) %>%
  mutate(county_party = if_else(per_gop >= per_dem, "R", "D")) %>%
  drop_na()
df_normalized
```

```{r adding-state-party}
df_state_party <-
  df_normalized %>%
  group_by(state) %>%
  summarize(state_tot = sum(total_2016), dem_total = sum(dem_2016), gop_total = sum(gop_2016)) %>%
  mutate(state_party = if_else(gop_total >= dem_total, "R","D")) %>%
  select(state, state_party)
df_state_party
```

```{r normalizing-state}
df_norm_state <-
  df_normalized %>%
  left_join(df_state_party, by = "state")
df_norm_state
```

```{r slimming-dataset}
df_normalized_slim <-
  df_norm_state %>%
  select(date, fips, county, state, population, cases_per100k, deaths_per100k, county_party, state_party)
df_normalized_slim
```

```{r filter-one-date}
df_normalized_slim %>%
  filter(date == "2020-10-15") %>%
  arrange(desc(cases_per100k))
```

```{r df-new-cases}
df_new_cases <-
  df_norm_state %>%
  group_by(fips) %>%
  mutate(
    new_cases = cases - lag(cases, default = 0),
    new_cases_per100k = new_cases/population*100000,
    new_deaths = deaths - lag(deaths, default = 0),
    new_deaths_per100k = new_deaths/population*100000
    )%>%
  mutate(roll7 = (new_cases +
           lag(new_cases, n = 2L, default = 0)+
           lag(new_cases, n = 3L, default = 0)+
           lag(new_cases, n = 4L, default = 0)+
           lag(new_cases, n = 5L, default = 0)+
           lag(new_cases, n = 6L, default = 0)+
           lag(new_cases, n = 7L, default = 0))/7
         ) %>%
  mutate(roll7_deaths = (new_deaths +
           lag(new_deaths, n = 2L, default = 0)+
           lag(new_deaths, n = 3L, default = 0)+
           lag(new_deaths, n = 4L, default = 0)+
           lag(new_deaths, n = 5L, default = 0)+
           lag(new_deaths, n = 6L, default = 0)+
           lag(new_deaths, n = 7L, default = 0))/7
         ) %>%
  mutate(
    roll7_per100k= roll7/population * 100000,
    roll7_deaths_per100k= roll7_deaths/population * 100000,
  )

df_new_cases
```

```{r polish1}
theme_common <- function() {
  theme_minimal() %+replace%
  theme(
    axis.text.x = element_text(size = 10),
    axis.text.y = element_text(size = 10),
    axis.title.x = element_text(margin = margin(4, 4, 4, 4), size = 12),
    axis.title.y = element_text(margin = margin(4, 4, 4, 4), size = 12, angle = 90),

    legend.title = element_text(size = 12),
    legend.text = element_text(size = 10),

    strip.text.x = element_text(size = 12),
    strip.text.y = element_text(size = 12),

    panel.background = element_rect(fill = "grey95", color = "white"),
    panel.grid.major = element_line(color = "grey80"),
    panel.grid.minor = element_line(color = "grey80"),

    aspect.ratio = 4 / 6,

    plot.margin = unit(c(t = +0, b = +0, r = +0, l = +0), "cm"),
    plot.title = element_text(size = 18, vjust = 2),
    #plot.title.position = "plot",
    plot.subtitle = element_text(size = 16),
    plot.caption = element_text(size = 12)
  )
}
```

```{r polish2}
df_new_cases %>%
  filter(date >= as.Date("2020-03-15")) %>%
  group_by(date, state_party) %>%
  summarize(mean_new_cases = mean(new_cases), new_cases = sum(new_cases), new_cases_per100k = sum(new_cases_per100k), roll7 = sum(roll7), roll7_per100k = sum(roll7_per100k)) %>%
  ggplot()+
  geom_line(aes(date, roll7, color = state_party)) +
  scale_color_manual(labels = c("Democratic", "Republican"), values = c('Blue','Red'))+
  labs(
    title = "New Covid Cases over Time by Political Party",
    x = "Date",
    y = "7 Day Average of New Cases",
    color = "State Party"
  ) +
  theme_common()
```

```{r polish3}
df_new_cases %>%
  filter(date >= as.Date("2020-03-15")) %>%
  group_by(date, state_party) %>%
  summarize(roll7_deaths = sum(roll7_deaths), roll7_deaths_per100k = sum(roll7_deaths_per100k)) %>%
  ggplot()+
  geom_line(aes(date, roll7_deaths, color = state_party)) +
  scale_color_manual(labels = c("Democratic", "Republican"), values = c('Blue','Red'))+
  labs(
    title = "New Covid Deaths over Time by Political Party",
    x = "Date",
    y = "7 Day Average of New Deaths",
    color = "State Party"
  ) +
  theme_common()
```

```{r polish4}
df_norm_state %>%
  filter(date >= as.Date("2020-03-15")) %>%
  group_by(date, state_party) %>%
  summarize(cases = sum(cases), mean_per100k = mean(cases_per100k)) %>%
  ggplot()+
  geom_line(aes(date, cases, color = state_party))+
  scale_color_manual(labels = c("Democratic", "Republican"), values = c('Blue','Red'))+
  labs(
    title = "Total Covid Cases over Time by Political Party",
    x = "Date",
    y = "Total Covid Cases",
    color = "State Party"
  ) +
  theme_common()
```

```{r polish5}
df_norm_state %>%
  filter(date >= as.Date("2020-03-15")) %>%
  group_by(date, state_party) %>%
  summarize(deaths = sum(deaths), meandeaths_per100k = mean(deaths_per100k)) %>%
  ggplot()+
  geom_line(aes(date, deaths, color = state_party)) +
  #scale_y_log10() +
  scale_color_manual(labels = c("Democratic", "Republican"), values = c('Blue','Red'))+
  labs(
    title = "Total Covid Deaths over Time by Political Party",
    x = "Date",
    y = "Total Covid Deaths",
    color = "State Party"
  ) +
  theme_common()
```

**Remaining Questions:**
Put in sentence form but some ideas: How does the socioeconomic status of an area impact COVID/ potentially blur our results?